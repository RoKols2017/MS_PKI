# Где запускать скрипты

## Общие принципы

Большинство скриптов проекта запускаются на **CA1 (Issuing CA)** сервере, так как это основной онлайн-сервер PKI инфраструктуры.

## Таблица запуска скриптов

| Скрипт | Где запускать | Примечание |
|--------|---------------|------------|
| `Initialize-PkiConfig.ps1` | **CA1** | Определяет параметры CA1, IIS, домена |
| `Get-CA0Config.ps1` | **CA0** | Собирает параметры Root CA |
| `Invoke-PkiAudit.ps1` | **CA1** | Аудит всей инфраструктуры (CA0, CA1, IIS) |
| `Invoke-PkiValidation.ps1` | **CA1** | Валидация PKI здоровья |
| `Invoke-PkiAlignment.ps1` | **CA1** | Выравнивание конфигурации |
| `Invoke-PkiRollback.ps1` | **CA1** | Откат изменений |

## Детали по скриптам

### Initialize-PkiConfig.ps1

**Где:** CA1 (Issuing CA) сервер

**Почему:** Скрипт определяет параметры CA1, IIS, домена, которые доступны только на CA1.

**Требования:**
- Права локального администратора (Administrators) — **ОБЯЗАТЕЛЬНО**
- Права Domain Admin — рекомендуется для получения информации о домене

### Get-CA0Config.ps1

**Где:** CA0 (Root CA) сервер

**Почему:** CA0 обычно offline и находится на отдельном сервере. Скрипт собирает параметры Root CA из реестра и certutil.

**Требования:**
- Права локального администратора (Administrators) — **ОБЯЗАТЕЛЬНО**
- CA0 сервер должен быть включен (если он offline)

**Процедура:**
1. Включите CA0 сервер (если он offline)
2. Запустите скрипт на CA0
3. Скопируйте выведенные параметры
4. На CA1 вставьте их в секцию `ca0` файла `config\env.json`

### Invoke-PkiAudit.ps1

**Где:** CA1 (Issuing CA) сервер

**Почему:** 
- Скрипт собирает данные о CA1 (Issuing CA) напрямую
- Для CA0 (Root CA) использует конфигурацию из `env.json` и доступные данные
- IIS находится на CA1
- Клиентские данные собираются через доступные механизмы

**Требования:**
- Права локального администратора (Administrators) — **ОБЯЗАТЕЛЬНО**
- Конфигурация `env.json` должна быть заполнена (включая параметры CA0)

### Invoke-PkiValidation.ps1

**Где:** CA1 (Issuing CA) сервер

**Почему:** Проверяет доступность CRL, AIA через HTTP, статус службы CA, что доступно на CA1.

**Требования:**
- Права локального администратора (Administrators) — **ОБЯЗАТЕЛЬНО**
- Конфигурация `env.json` должна быть заполнена

### Invoke-PkiAlignment.ps1

**Где:** CA1 (Issuing CA) сервер

**Почему:** Изменяет конфигурацию CA1, IIS, что находится на CA1.

**Требования:**
- Права локального администратора (Administrators) — **ОБЯЗАТЕЛЬНО**
- Конфигурация `env.json` должна быть заполнена
- Baseline должен быть создан через `Invoke-PkiAudit.ps1`

**Важно:** Скрипт работает в режиме WhatIf по умолчанию. Для применения изменений используйте `-Apply`.

### Invoke-PkiRollback.ps1

**Где:** CA1 (Issuing CA) сервер

**Почему:** Откатывает изменения, сделанные на CA1 через `Invoke-PkiAlignment.ps1`.

**Требования:**
- Права локального администратора (Administrators) — **ОБЯЗАТЕЛЬНО**
- Файл `alignment_plan_*.json` должен существовать (создается при применении изменений)

## Исключения и особые случаи

### CA0 (Root CA) операции

Для операций на CA0 (Root CA) требуется:
1. Включить CA0 сервер (если он offline)
2. Запустить соответствующие команды напрямую на CA0
3. Использовать runbooks для ручных операций:
   - `docs/Runbooks/RootCRL_Runbook.md` — публикация Root CA CRL

### Сетевой доступ

Некоторые скрипты могут требовать сетевого доступа:
- Доступ к CA0 (если CA0 online)
- Доступ к IIS на CA1 через HTTP/HTTPS
- Доступ к домену Active Directory

## Рекомендации

1. **Всегда запускайте скрипты из корня проекта** на CA1
2. **Используйте PowerShell от имени администратора**
3. **Проверяйте права** перед запуском скриптов
4. **Для CA0 операций** используйте соответствующие runbooks

## Связанные документы

- [`README.md`](../README.md) — главный файл проекта
- [`QUICKSTART.md`](../QUICKSTART.md) — быстрый старт
- [`docs/ADMIN_START_GUIDE.md`](ADMIN_START_GUIDE.md) — руководство для администратора
- [`docs/Initialize-PkiConfig_Guide.md`](Initialize-PkiConfig_Guide.md) — настройка конфигурации
- [`docs/Get-CA0Config_Guide.md`](Get-CA0Config_Guide.md) — сбор параметров CA0
- [`docs/Runbooks/RootCRL_Runbook.md`](Runbooks/RootCRL_Runbook.md) — операции на CA0
