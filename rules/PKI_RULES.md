# PKI Rules & Safety Guidelines

## Обязательные правила безопасности

### 1. Read-Only по умолчанию

**Правило**: Все скрипты работают в режиме чтения (read-only) по умолчанию.

**Исключение**: Изменения возможны только при явном указании флага `-Apply`.

**Проверка**: Каждая функция, выполняющая изменения, должна проверять наличие `-Apply` или `$PSCmdlet.ShouldProcess()`.

```powershell
if (-not $Apply) {
    Write-Warning "Режим WhatIf. Используйте -Apply для применения изменений."
    return
}
```

---

### 2. Backup обязателен

**Правило**: Перед любыми изменениями конфигурации должен создаваться backup.

**Требования**:
- Backup реестра CA (reg export)
- Backup IIS конфигурации (appcmd backup)
- Backup сертификатов и CRL (копирование файлов)
- Timestamp в имени backup
- Сохранение пути к backup в метаданных операции

**Формат backup**:
```
output/backups/{timestamp}_{operation}_{rollbackPointName}/
```

---

### 3. Rollback обязателен

**Правило**: Каждая операция изменения должна поддерживать rollback.

**Требования**:
- Каждая операция создаёт rollback point
- Rollback point содержит:
  - Путь к backup
  - Список изменённых параметров
  - Timestamp
  - Описание изменений
- Rollback должен быть полностью автоматизирован

**Формат rollback point**:
```json
{
  "timestamp": "2026-01-22T20:00:00Z",
  "operation": "CRLPublicationURLs_Update",
  "backupPath": "output/backups/...",
  "changes": [
    {
      "parameter": "CRLPublicationURLs",
      "oldValue": "...",
      "newValue": "..."
    }
  ],
  "rollbackScript": "path/to/rollback.ps1"
}
```

---

### 4. Legacy сохраняется всегда

**Правило**: Legacy пути и конфигурации никогда не удаляются.

**Legacy namespace** (нельзя удалять):
- `/Certs`
- `/CertsAIA`
- `/IssCA/*`
- `/ssCA/*`

**Принцип**: Legacy пути остаются как compatibility layer. Новые пути добавляются параллельно.

**Запрещено**:
- Удаление legacy virtual directories в IIS
- Удаление legacy путей из CRLPublicationURLs
- Удаление legacy путей из CACertPublicationURLs
- Изменение существующих legacy путей

---

### 5. Никаких удалений CA

**Правило**: CA никогда не удаляется из системы.

**Запрещено**:
- `certutil -delcat`
- Удаление объектов CA из AD
- Удаление сертификатов CA из хранилища
- Удаление конфигурации CA из реестра

**Разрешено**:
- Изменение конфигурации CA
- Добавление новых путей публикации
- Обновление CRL
- Изменение шаблонов

---

### 6. Никакого Re-Root

**Правило**: Trust chain не изменяется.

**Запрещено**:
- Изменение Root CA сертификата
- Изменение цепочки доверия
- Переключение на новый Root CA
- Массовая замена сертификатов

**Разрешено**:
- Добавление новых промежуточных CA (CA2, CA3)
- Расширение trust chain вниз (не вверх)

---

### 7. Никакого массового перевыпуска

**Правило**: Массовый перевыпуск сертификатов запрещён.

**Запрещено**:
- Скрипты для массового перевыпуска
- Автоматический перевыпуск всех сертификатов
- Принудительная отзыв и перевыпуск

**Разрешено**:
- Перевыпуск по истечении срока действия (естественный)
- Перевыпуск по запросу пользователя
- Перевыпуск через Autoenrollment (GPO)

---

### 8. Evidence-Driven подход

**Правило**: Все изменения основаны на собранных данных (evidence).

**Процесс**:
1. **Audit** — сбор данных (Phase 1)
2. **Analysis** — анализ данных и выявление проблем
3. **Planning** — планирование изменений на основе evidence
4. **Validation** — проверка плана
5. **Execution** — выполнение только при `-Apply`
6. **Verification** — проверка результата

**Требования**:
- Каждое изменение должно быть обосновано данными из audit
- План изменений должен ссылаться на конкретные evidence
- После изменений должен собираться новый audit для сравнения

---

### 9. Zero-Downtime

**Правило**: Изменения не должны вызывать простои сервисов.

**Требования**:
- CA Service не должен останавливаться
- IIS не должен перезапускаться без необходимости
- CRL должен оставаться доступным
- Новые пути добавляются перед удалением старых (если требуется)

**Проверки**:
- Health check перед изменениями
- Health check после изменений
- Мониторинг доступности CRL во время изменений

---

### 10. CRL-First приоритет

**Правило**: Доступность CRL — критический приоритет.

**Требования**:
- CRL должен быть доступен по HTTP
- CRL должен быть актуальным (не expired)
- CRL overlap должен быть достаточным
- Множественные пути публикации CRL (redundancy)

**Проверки**:
- HTTP доступность всех CRLPublicationURLs
- Проверка NextUpdate всех CRL
- Проверка overlap period
- Проверка целостности CRL файлов

---

### 11. Документация обязательна

**Правило**: Каждое изменение должно документироваться.

**Требования**:
- Автоматическая генерация документации
- Документация на русском языке
- Описание AS-IS состояния
- Описание TO-BE состояния
- Описание изменений
- Rollback инструкции

**Форматы**:
- Markdown (основной)
- JSON (машиночитаемый)
- XML/EVTX (evidence)

---

### 12. Логирование всех операций

**Правило**: Все операции должны логироваться.

**Требования**:
- Structured logging (JSON)
- Уровни: Debug, Info, Warning, Error
- Timestamp для каждой записи
- Context (роль, операция, параметры)
- Exit codes для автоматизации

**Формат лога**:
```json
{
  "timestamp": "2026-01-22T20:00:00Z",
  "level": "Info",
  "operation": "CRLPublicationURLs_Update",
  "role": "CA1",
  "message": "Обновление CRLPublicationURLs",
  "parameters": {...},
  "result": "Success",
  "duration_ms": 1234
}
```

---

## Best Practices

### Root CA (CA0)

- **CRL Validity**: 6-12 месяцев (целевое 12 месяцев)
- **CRL Overlap**: 1-2 недели
- **Delta CRL**: обычно не используется
- **Status**: Offline
- **CRL Publication**: через IIS на CA1

### Issuing CA (CA1)

- **CRL Validity**: 7-14 дней
- **CRL Overlap**: 1 день
- **Delta CRL**: рекомендуется
- **Status**: Online
- **CRL Publication**: HTTP-first, множественные пути

### Templates

- **v1 templates**: deprecated, не использовать
- **v2+ templates**: обязательно
- **Subject Name**: from AD
- **Autoenrollment**: через GPO
- **EKU**: по назначению (User, Computer, WebServer, Service)

### Autoenrollment

- **Control-plane**: GPO
- **Модель**: централизованная
- **OU + Security Filtering**: для управления scope
- **Monitoring**: через Event Logs

### HTTP (IIS)

- **Основной транспорт**: AIA/CDP
- **MIME types**:
  - `.crl` → `application/pkix-crl`
  - `.crt/.cer` → `application/x-x509-ca-cert`
- **Access**: Read-only
- **Namespace**: Legacy + Canonical параллельно

---

## Проверочный список перед изменениями

- [ ] Audit выполнен и baseline.json создан
- [ ] Evidence pack собран
- [ ] План изменений создан и проверен
- [ ] Backup создан
- [ ] Rollback point создан
- [ ] Health check пройден
- [ ] Legacy пути не затрагиваются
- [ ] CA не удаляется
- [ ] Re-root не выполняется
- [ ] Массовый перевыпуск не выполняется
- [ ] Документация обновлена
- [ ] Логирование включено
- [ ] `-Apply` флаг установлен (если требуется)

---

## Exit Codes

- `0` — успех
- `1` — общая ошибка
- `2` — ошибка конфигурации
- `3` — ошибка доступа (права)
- `4` — ошибка валидации
- `5` — ошибка backup
- `6` — ошибка rollback
- `10` — WhatIf режим (не ошибка, но изменения не применены)
